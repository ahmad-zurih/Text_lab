Bootstrap: docker
From: nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

%post
    # Update system
    apt update
    apt install -y software-properties-common
    add-apt-repository -y 'deb http://archive.ubuntu.com/ubuntu jammy-backports main'
    apt update && apt upgrade -y

    echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | debconf-set-selections
    apt install -y ttf-mscorefonts-installer
    apt install -y poppler-utils msttcorefonts fonts-crosextra-caladea fonts-crosextra-carlito gsfonts lcdf-typetools

    # Install all required dependencies in one command
    apt install -y --no-install-recommends \
        build-essential curl ffmpeg git \
        libsndfile1-dev tesseract-ocr espeak-ng \
        python3.11 python3-pip python3.11-dev libc6 libc-bin \
        pciutils lshw

    # set 3.11# Install both python3.10 and python3.11 as alternatives
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 2

    # Option 1: Force python3 to be python3.11
    update-alternatives --set python3 /usr/bin/python3.11

    # Verify
    python3 --version

    # Upgrade Python pip
    python3 -m pip install --no-cache-dir --upgrade pip

    # Install Python packages
    pip install --no-cache-dir \
        scikit-learn umap-learn matplotlib pandas seaborn \
        opencv-python-headless scikit-image mlflow datasets \
        flask requests Flask-Cors ollama

    git clone https://github.com/allenai/olmocr.git
    cd olmocr
    pip install -e .

    pip install sgl-kernel==0.0.3.post1 --force-reinstall --no-deps
    pip install "sglang[all]==0.4.2" --find-links https://flashinfer.ai/whl/cu124/torch2.4/flashinfer/
    pip install PyPDF2
    pip install --upgrade pymupdf

    # Clean up to reduce container size
    apt clean && rm -rf /var/lib/apt/lists/*